// fruitjam_font.h — unscii-8-thin bitmap font + rendering functions
//
// Font data auto-generated from unscii-8-thin.hex by tools/unscii_hex_to_header.py
// Rendering functions hand-written for direct 8bpp framebuffer access (DVHSTX8).
//
// 8×8 row-major bitmap font, 128 glyphs (ASCII 0x00–0x7F)
// 8 bytes per glyph, one byte per row, MSB = leftmost pixel
// Total: 1024 bytes
//
// Used by:
//   - fruitjam_terminal.h (term_draw_cell) for terminal text
//   - ulisp-fruit-jam.ino (fn_drawchar, gfxwrite) for graphics-mode text

#ifndef FRUITJAM_FONT_H
#define FRUITJAM_FONT_H

#include <stdint.h>

static const uint8_t unscii_8_thin[128 * 8] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // 0x00 NUL
  0xE0, 0x80, 0xEA, 0x2A, 0xEE, 0x0A, 0x0A, 0x00,  // 0x01
  0xE0, 0x80, 0xEA, 0x2A, 0xE4, 0x0A, 0x0A, 0x00,  // 0x02
  0xE0, 0x80, 0xCA, 0x8A, 0xE4, 0x0A, 0x0A, 0x00,  // 0x03
  0xE0, 0x80, 0xCE, 0x84, 0xE4, 0x04, 0x04, 0x00,  // 0x04
  0xE0, 0x80, 0xCE, 0x8A, 0xEA, 0x0E, 0x04, 0x00,  // 0x05
  0xE0, 0xA0, 0xEA, 0xAA, 0xAC, 0x0A, 0x0A, 0x00,  // 0x06
  0xC0, 0xA0, 0xC8, 0xA8, 0xC8, 0x08, 0x0E, 0x00,  // 0x07 BEL
  0xC0, 0xA0, 0xCE, 0xA8, 0xCE, 0x02, 0x0E, 0x00,  // 0x08 BS
  0xA0, 0xA0, 0xEE, 0xA4, 0xA4, 0x04, 0x04, 0x00,  // 0x09 TAB
  0x80, 0x80, 0x8E, 0x88, 0xEC, 0x08, 0x08, 0x00,  // 0x0A LF
  0xA0, 0xA0, 0xAE, 0xA4, 0x44, 0x04, 0x04, 0x00,  // 0x0B
  0xE0, 0x80, 0xCE, 0x88, 0x8C, 0x08, 0x08, 0x00,  // 0x0C
  0xE0, 0x80, 0x8E, 0x8A, 0xEE, 0x0C, 0x0A, 0x00,  // 0x0D CR
  0xE0, 0x80, 0xEE, 0x2A, 0xEA, 0x0A, 0x0E, 0x00,  // 0x0E
  0xE0, 0x80, 0xEE, 0x24, 0xE4, 0x04, 0x0E, 0x00,  // 0x0F
  0xC0, 0xA0, 0xA8, 0xA8, 0xC8, 0x08, 0x0E, 0x00,  // 0x10
  0xC0, 0xA0, 0xA4, 0xAC, 0xC4, 0x04, 0x0E, 0x00,  // 0x11
  0xC0, 0xA0, 0xAE, 0xA2, 0xCE, 0x08, 0x0E, 0x00,  // 0x12
  0xC0, 0xA0, 0xAE, 0xA2, 0xC6, 0x02, 0x0E, 0x00,  // 0x13
  0xC0, 0xA0, 0xAA, 0xAA, 0xCE, 0x02, 0x02, 0x00,  // 0x14
  0xE0, 0xA0, 0xAA, 0xAA, 0xAC, 0x0A, 0x0A, 0x00,  // 0x15
  0xE0, 0x80, 0xEA, 0x2A, 0xEE, 0x04, 0x04, 0x00,  // 0x16
  0xE0, 0x80, 0xCC, 0x8A, 0xEC, 0x0A, 0x0C, 0x00,  // 0x17
  0xE0, 0x80, 0x8E, 0x8A, 0xEA, 0x0A, 0x0A, 0x00,  // 0x18
  0xE0, 0x80, 0xCA, 0x8E, 0xEA, 0x0A, 0x0A, 0x00,  // 0x19
  0x3C, 0x66, 0x66, 0x30, 0x18, 0x00, 0x18, 0x00,  // 0x1A
  0xE0, 0x80, 0xCE, 0x88, 0xE8, 0x08, 0x0E, 0x00,  // 0x1B ESC
  0xE0, 0x80, 0xCE, 0x88, 0x8E, 0x02, 0x0E, 0x00,  // 0x1C
  0xE0, 0x80, 0xAE, 0xA8, 0xEE, 0x02, 0x0E, 0x00,  // 0x1D
  0xE0, 0xA0, 0xEE, 0xC8, 0xAE, 0x02, 0x0E, 0x00,  // 0x1E
  0xA0, 0xA0, 0xAE, 0xA8, 0xEE, 0x02, 0x0E, 0x00,  // 0x1F
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // 0x20 ' '
  0x10, 0x10, 0x10, 0x10, 0x00, 0x00, 0x10, 0x00,  // 0x21 '!'
  0x24, 0x24, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00,  // 0x22 '"'
  0x24, 0x24, 0x7E, 0x24, 0x7E, 0x24, 0x24, 0x00,  // 0x23 '#'
  0x10, 0x3C, 0x50, 0x38, 0x14, 0x78, 0x10, 0x00,  // 0x24 '$'
  0x00, 0x62, 0x64, 0x08, 0x10, 0x26, 0x46, 0x00,  // 0x25 '%'
  0x30, 0x48, 0x48, 0x30, 0x4A, 0x44, 0x3A, 0x00,  // 0x26 '&'
  0x08, 0x10, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00,  // 0x27 'apostrophe'
  0x08, 0x10, 0x20, 0x20, 0x20, 0x10, 0x08, 0x00,  // 0x28 '('
  0x20, 0x10, 0x08, 0x08, 0x08, 0x10, 0x20, 0x00,  // 0x29 ')'
  0x10, 0x54, 0x38, 0x10, 0x38, 0x54, 0x10, 0x00,  // 0x2A '*'
  0x00, 0x10, 0x10, 0x7C, 0x10, 0x10, 0x00, 0x00,  // 0x2B '+'
  0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x10,  // 0x2C ','
  0x00, 0x00, 0x00, 0x00, 0x7C, 0x00, 0x00, 0x00,  // 0x2D '-'
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,  // 0x2E '.'
  0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x00,  // 0x2F '/'
  0x38, 0x44, 0x4C, 0x54, 0x64, 0x44, 0x38, 0x00,  // 0x30 '0'
  0x10, 0x30, 0x50, 0x10, 0x10, 0x10, 0x7C, 0x00,  // 0x31 '1'
  0x38, 0x44, 0x04, 0x08, 0x30, 0x40, 0x7C, 0x00,  // 0x32 '2'
  0x38, 0x44, 0x04, 0x18, 0x04, 0x44, 0x38, 0x00,  // 0x33 '3'
  0x08, 0x18, 0x28, 0x48, 0x7C, 0x08, 0x08, 0x00,  // 0x34 '4'
  0x7C, 0x40, 0x78, 0x04, 0x04, 0x44, 0x38, 0x00,  // 0x35 '5'
  0x1C, 0x20, 0x40, 0x78, 0x44, 0x44, 0x38, 0x00,  // 0x36 '6'
  0x7C, 0x04, 0x08, 0x10, 0x20, 0x20, 0x20, 0x00,  // 0x37 '7'
  0x38, 0x44, 0x44, 0x38, 0x44, 0x44, 0x38, 0x00,  // 0x38 '8'
  0x38, 0x44, 0x44, 0x3C, 0x04, 0x08, 0x70, 0x00,  // 0x39 '9'
  0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x00, 0x00,  // 0x3A ':'
  0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x10, 0x20,  // 0x3B ';'
  0x08, 0x10, 0x20, 0x40, 0x20, 0x10, 0x08, 0x00,  // 0x3C '<'
  0x00, 0x00, 0x7C, 0x00, 0x7C, 0x00, 0x00, 0x00,  // 0x3D '='
  0x20, 0x10, 0x08, 0x04, 0x08, 0x10, 0x20, 0x00,  // 0x3E '>'
  0x3C, 0x42, 0x04, 0x08, 0x08, 0x00, 0x08, 0x00,  // 0x3F '?'
  0x3C, 0x42, 0x4A, 0x56, 0x4C, 0x40, 0x3C, 0x00,  // 0x40 '@'
  0x18, 0x24, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x00,  // 0x41 'A'
  0x7C, 0x42, 0x42, 0x7C, 0x42, 0x42, 0x7C, 0x00,  // 0x42 'B'
  0x3C, 0x42, 0x40, 0x40, 0x40, 0x42, 0x3C, 0x00,  // 0x43 'C'
  0x78, 0x44, 0x42, 0x42, 0x42, 0x44, 0x78, 0x00,  // 0x44 'D'
  0x7E, 0x40, 0x40, 0x78, 0x40, 0x40, 0x7E, 0x00,  // 0x45 'E'
  0x7E, 0x40, 0x40, 0x78, 0x40, 0x40, 0x40, 0x00,  // 0x46 'F'
  0x3C, 0x42, 0x40, 0x4E, 0x42, 0x42, 0x3C, 0x00,  // 0x47 'G'
  0x42, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x00,  // 0x48 'H'
  0x38, 0x10, 0x10, 0x10, 0x10, 0x10, 0x38, 0x00,  // 0x49 'I'
  0x04, 0x04, 0x04, 0x04, 0x04, 0x44, 0x38, 0x00,  // 0x4A 'J'
  0x42, 0x44, 0x48, 0x70, 0x48, 0x44, 0x42, 0x00,  // 0x4B 'K'
  0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7E, 0x00,  // 0x4C 'L'
  0x42, 0x66, 0x5A, 0x42, 0x42, 0x42, 0x42, 0x00,  // 0x4D 'M'
  0x42, 0x62, 0x52, 0x4A, 0x46, 0x42, 0x42, 0x00,  // 0x4E 'N'
  0x3C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00,  // 0x4F 'O'
  0x7C, 0x42, 0x42, 0x7C, 0x40, 0x40, 0x40, 0x00,  // 0x50 'P'
  0x3C, 0x42, 0x42, 0x42, 0x4A, 0x44, 0x3A, 0x00,  // 0x51 'Q'
  0x7C, 0x42, 0x42, 0x7C, 0x48, 0x44, 0x42, 0x00,  // 0x52 'R'
  0x3C, 0x42, 0x40, 0x3C, 0x02, 0x42, 0x3C, 0x00,  // 0x53 'S'
  0x7C, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00,  // 0x54 'T'
  0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00,  // 0x55 'U'
  0x42, 0x42, 0x42, 0x42, 0x42, 0x24, 0x18, 0x00,  // 0x56 'V'
  0x42, 0x42, 0x42, 0x42, 0x5A, 0x66, 0x42, 0x00,  // 0x57 'W'
  0x42, 0x42, 0x24, 0x18, 0x24, 0x42, 0x42, 0x00,  // 0x58 'X'
  0x44, 0x44, 0x44, 0x38, 0x10, 0x10, 0x10, 0x00,  // 0x59 'Y'
  0x7C, 0x04, 0x08, 0x10, 0x20, 0x40, 0x7C, 0x00,  // 0x5A 'Z'
  0x38, 0x20, 0x20, 0x20, 0x20, 0x20, 0x38, 0x00,  // 0x5B '['
  0x80, 0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x00,  // 0x5C 'backslash'
  0x38, 0x08, 0x08, 0x08, 0x08, 0x08, 0x38, 0x00,  // 0x5D ']'
  0x10, 0x28, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00,  // 0x5E '^'
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C,  // 0x5F '_'
  0x20, 0x10, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,  // 0x60 '`'
  0x00, 0x00, 0x38, 0x04, 0x3C, 0x44, 0x3C, 0x00,  // 0x61 'a'
  0x40, 0x40, 0x78, 0x44, 0x44, 0x44, 0x78, 0x00,  // 0x62 'b'
  0x00, 0x00, 0x38, 0x44, 0x40, 0x44, 0x38, 0x00,  // 0x63 'c'
  0x04, 0x04, 0x3C, 0x44, 0x44, 0x44, 0x3C, 0x00,  // 0x64 'd'
  0x00, 0x00, 0x38, 0x44, 0x7C, 0x40, 0x38, 0x00,  // 0x65 'e'
  0x0C, 0x12, 0x10, 0x7C, 0x10, 0x10, 0x10, 0x00,  // 0x66 'f'
  0x00, 0x00, 0x3C, 0x44, 0x44, 0x3C, 0x04, 0x38,  // 0x67 'g'
  0x40, 0x40, 0x78, 0x44, 0x44, 0x44, 0x44, 0x00,  // 0x68 'h'
  0x10, 0x00, 0x30, 0x10, 0x10, 0x10, 0x38, 0x00,  // 0x69 'i'
  0x04, 0x00, 0x0C, 0x04, 0x04, 0x04, 0x24, 0x18,  // 0x6A 'j'
  0x40, 0x40, 0x44, 0x48, 0x70, 0x48, 0x44, 0x00,  // 0x6B 'k'
  0x30, 0x10, 0x10, 0x10, 0x10, 0x10, 0x38, 0x00,  // 0x6C 'l'
  0x00, 0x00, 0x68, 0x54, 0x54, 0x54, 0x54, 0x00,  // 0x6D 'm'
  0x00, 0x00, 0x78, 0x44, 0x44, 0x44, 0x44, 0x00,  // 0x6E 'n'
  0x00, 0x00, 0x38, 0x44, 0x44, 0x44, 0x38, 0x00,  // 0x6F 'o'
  0x00, 0x00, 0x78, 0x44, 0x44, 0x78, 0x40, 0x40,  // 0x70 'p'
  0x00, 0x00, 0x3C, 0x44, 0x44, 0x3C, 0x04, 0x04,  // 0x71 'q'
  0x00, 0x00, 0x5C, 0x60, 0x40, 0x40, 0x40, 0x00,  // 0x72 'r'
  0x00, 0x00, 0x3C, 0x40, 0x38, 0x04, 0x78, 0x00,  // 0x73 's'
  0x20, 0x20, 0x78, 0x20, 0x20, 0x24, 0x18, 0x00,  // 0x74 't'
  0x00, 0x00, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00,  // 0x75 'u'
  0x00, 0x00, 0x44, 0x44, 0x44, 0x28, 0x10, 0x00,  // 0x76 'v'
  0x00, 0x00, 0x44, 0x54, 0x54, 0x54, 0x28, 0x00,  // 0x77 'w'
  0x00, 0x00, 0x44, 0x28, 0x10, 0x28, 0x44, 0x00,  // 0x78 'x'
  0x00, 0x00, 0x44, 0x44, 0x44, 0x3C, 0x04, 0x38,  // 0x79 'y'
  0x00, 0x00, 0x7C, 0x08, 0x10, 0x20, 0x7C, 0x00,  // 0x7A 'z'
  0x18, 0x20, 0x20, 0x40, 0x20, 0x20, 0x18, 0x00,  // 0x7B '{'
  0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,  // 0x7C '|'
  0x30, 0x08, 0x08, 0x04, 0x08, 0x08, 0x30, 0x00,  // 0x7D '}'
  0x20, 0x54, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,  // 0x7E '~'
  0xC0, 0xA0, 0xAE, 0xA4, 0xC4, 0x04, 0x04, 0x00,  // 0x7F DEL
};

// ---- Rendering functions ----
// These write directly into an 8bpp framebuffer (uint8_t* buffer, stride = screen width).
// They are used by both the terminal emulator and graphics-mode text functions.
// The display8 object (DVHSTX8) is declared in fruitjam_terminal.h and must be
// available when these functions are called.

// Draw a single 8×8 character at pixel position (x, y) with foreground/background colors.
// Characters outside 0x00–0x7F are drawn as blank (background only).
// No clipping — caller must ensure (x, y) is within the framebuffer.
// This is the fast path for terminal rendering (size=1, no clipping needed).
static void fruitjam_draw_char_8x8(uint8_t *fb, int fb_width,
                                    int x, int y, unsigned char c,
                                    uint8_t fg, uint8_t bg) {
  const uint8_t *glyph = &unscii_8_thin[(c & 0x7F) * 8];
  uint8_t *row_ptr = fb + y * fb_width + x;
  for (int row = 0; row < 8; row++) {
    uint8_t bits = glyph[row];
    row_ptr[0] = (bits & 0x80) ? fg : bg;
    row_ptr[1] = (bits & 0x40) ? fg : bg;
    row_ptr[2] = (bits & 0x20) ? fg : bg;
    row_ptr[3] = (bits & 0x10) ? fg : bg;
    row_ptr[4] = (bits & 0x08) ? fg : bg;
    row_ptr[5] = (bits & 0x04) ? fg : bg;
    row_ptr[6] = (bits & 0x02) ? fg : bg;
    row_ptr[7] = (bits & 0x01) ? fg : bg;
    row_ptr += fb_width;
  }
}

// Draw a single 8×8 character with transparent background (foreground pixels only).
// Used when set-text-color is called with one argument (GFX convention: fg == bg).
static void fruitjam_draw_char_8x8_transparent(uint8_t *fb, int fb_width,
                                                int fb_height,
                                                int x, int y, unsigned char c,
                                                uint8_t fg) {
  if (x >= fb_width || y >= fb_height || (x + 8) <= 0 || (y + 8) <= 0) return;
  const uint8_t *glyph = &unscii_8_thin[(c & 0x7F) * 8];
  for (int row = 0; row < 8; row++) {
    int py = y + row;
    if (py < 0 || py >= fb_height) continue;
    uint8_t bits = glyph[row];
    uint8_t *row_ptr = fb + py * fb_width + x;
    for (int col = 0; col < 8; col++) {
      int px = x + col;
      if (px >= 0 && px < fb_width && (bits & (0x80 >> col)))
        row_ptr[col] = fg;
    }
  }
}

// Draw a scaled 8×8 character at pixel position (x, y).
// Each pixel is expanded to (size × size) pixels.
// Includes clipping against (clip_w, clip_h) screen bounds.
// Used by graphics-mode (draw-char x y c [fg bg size]) for size >= 1.
static void fruitjam_draw_char_8x8_scaled(uint8_t *fb, int fb_width, int fb_height,
                                           int x, int y, unsigned char c,
                                           uint8_t fg, uint8_t bg, int size) {
  if (size < 1) size = 1;
  // Quick reject if entirely off-screen
  if (x >= fb_width || y >= fb_height ||
      (x + 8 * size) <= 0 || (y + 8 * size) <= 0) return;

  const uint8_t *glyph = &unscii_8_thin[(c & 0x7F) * 8];
  for (int row = 0; row < 8; row++) {
    uint8_t bits = glyph[row];
    for (int col = 0; col < 8; col++) {
      uint8_t color = (bits & (0x80 >> col)) ? fg : bg;
      // Fill the size×size block for this pixel
      for (int sy = 0; sy < size; sy++) {
        int py = y + row * size + sy;
        if (py < 0 || py >= fb_height) continue;
        for (int sx = 0; sx < size; sx++) {
          int px = x + col * size + sx;
          if (px < 0 || px >= fb_width) continue;
          fb[py * fb_width + px] = color;
        }
      }
    }
  }
}

// Draw a scaled 8×8 character with transparent background (foreground pixels only).
static void fruitjam_draw_char_8x8_scaled_transparent(uint8_t *fb, int fb_width,
                                                       int fb_height,
                                                       int x, int y, unsigned char c,
                                                       uint8_t fg, int size) {
  if (size < 1) size = 1;
  if (x >= fb_width || y >= fb_height ||
      (x + 8 * size) <= 0 || (y + 8 * size) <= 0) return;
  const uint8_t *glyph = &unscii_8_thin[(c & 0x7F) * 8];
  for (int row = 0; row < 8; row++) {
    uint8_t bits = glyph[row];
    for (int col = 0; col < 8; col++) {
      if (!(bits & (0x80 >> col))) continue;
      for (int sy = 0; sy < size; sy++) {
        int py = y + row * size + sy;
        if (py < 0 || py >= fb_height) continue;
        for (int sx = 0; sx < size; sx++) {
          int px = x + col * size + sx;
          if (px < 0 || px >= fb_width) continue;
          fb[py * fb_width + px] = fg;
        }
      }
    }
  }
}

#endif // FRUITJAM_FONT_H
