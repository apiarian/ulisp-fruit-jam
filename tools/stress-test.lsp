;;; PSRAM Stress Test for uLisp Fruit Jam
;;;
;;; Exercises PSRAM data integrity alongside all hardware subsystems:
;;; graphics (HSTX DMA), audio (I2S DMA), keyboard, mouse, and GC.
;;; Runs continuously until Escape is pressed.
;;; Returns the number of data integrity errors detected (0 = pass).
;;;
;;; Display: 512x384 @ 8bpp (matches DVHSTX8 resolution)
;;;
;;; Usage:
;;;   (stress-test)       ; run until Escape
;;;   (stress-test 100)   ; run 100 rounds then stop
;;;
;;; Load via: (package-load "stress-test.lsp")
;;; Or paste individual functions at the REPL.
;;;
;;; Array sizes can be adjusted â€” larger arrays stress PSRAM bandwidth
;;; more but take longer per round (~7s at 5K/5K/1K).

(defun stress-fill (arr n seed)
  (dotimes (i n)
    (setf (aref arr i) (logand (+ (* i 31) seed) #xFFFF))))

(defun stress-check (arr n seed)
  (let ((errs 0))
    (dotimes (i n)
      (unless (= (aref arr i) (logand (+ (* i 31) seed) #xFFFF))
        (incf errs)))
    errs))

(defun stress-bar (x y w h val maxv col)
  (fill-rect x y w h 0)
  (draw-rect x y w h 64)
  (let ((fw (truncate (* w val) maxv)))
    (when (> fw 0)
      (fill-rect (+ x 1) (+ y 1) (min fw (- w 2)) (- h 2) col))))

(defun stress-text (x y msg col)
  (set-cursor x y)
  (set-text-color col 0)
  (with-gfx (s) (princ msg s)))

(defun stress-log (msg col)
  (when (> *log-y* 348)
    (fill-rect 0 296 511 56 0)
    (setq *log-y* 298))
  (set-cursor 8 *log-y*)
  (set-text-color col 0)
  (with-gfx (s) (princ msg s))
  (setq *log-y* (+ *log-y* 10)))

(defun stress-test (&optional (rounds 0))
  (let ((arr1 (make-array 5000))
        (arr2 (make-array 5000))
        (arr3 (make-array 1000))
        (errors 0)
        (round 0)
        (max-rounds rounds)
        (gc-count 0)
        (start-time (millis))
        (last-gc-time 0))
    (graphics-mode)
    (fill-screen 0)
    (mouse-show)
    (set-text-size 2)
    (stress-text 120 8 "PSRAM Stress Test" 223)
    (set-text-size 1)
    (draw-line 0 30 511 30 64)
    (stress-text 8 40 "Round:" 150)
    (stress-text 8 55 "Errors:" 150)
    (stress-text 8 70 "GC runs:" 150)
    (stress-text 8 85 "Elapsed:" 150)
    (stress-text 8 110 "Array 1 (5K):" 150)
    (stress-text 8 128 "Array 2 (5K):" 150)
    (stress-text 8 146 "Array 3 (1K):" 150)
    (stress-text 8 170 "GC pressure:" 150)
    (stress-text 8 194 "Audio:" 150)
    (stress-text 8 218 "Graphics:" 150)
    (draw-line 0 240 511 240 64)
    (stress-text 280 40 "GFX stress zone:" 150)
    (draw-rect 278 52 226 184 64)
    (draw-line 0 276 511 276 64)
    (stress-text 8 282 "Activity log:" 150)
    (draw-line 0 356 511 356 64)
    (stress-text 8 366 "Esc=quit  Mouse+KB active" 150)
    (audio-wave 0 1) (audio-vol 0 60)
    (audio-wave 1 2) (audio-vol 1 40)
    (keyboard-flush)
    (defvar *log-y* 298)
    (setq *log-y* 298)
    (loop
      (incf round)
      (audio-note 0 (+ 60 (mod round 12)) 100)
      (fill-rect 80 40 100 8 0)
      (stress-text 80 40 round 223)
      (stress-log (format nil "R~a: fill" round) 28)
      (stress-fill arr1 5000 (* round 7))
      (stress-fill arr2 5000 (* round 13))
      (stress-fill arr3 1000 (* round 29))
      (stress-bar 130 108 130 12 1 3 28)
      (stress-log "gc-pressure" 220)
      (let ((gc-start (millis)))
        (dotimes (i 500)
          (list i (* i i) (+ i 1) (logand i 255)))
        (incf gc-count)
        (setq last-gc-time (- (millis) gc-start)))
      (fill-rect 80 70 100 8 0)
      (stress-text 80 70 gc-count 223)
      (stress-bar 130 168 130 12 (min last-gc-time 500) 500 220)
      (stress-log "verify" 3)
      (let ((e1 (stress-check arr1 5000 (* round 7)))
            (e2 (stress-check arr2 5000 (* round 13)))
            (e3 (stress-check arr3 1000 (* round 29))))
        (stress-bar 130 108 130 12 2 3 28)
        (stress-bar 130 126 130 12 2 3 28)
        (stress-bar 130 144 130 12 2 3 28)
        (let ((round-errs (+ e1 e2 e3)))
          (incf errors round-errs)
          (fill-rect 80 55 150 8 0)
          (stress-text 80 55 errors (if (= errors 0) 28 192))))
      (stress-fill arr3 1000 (+ (* round 29) 1))
      (let ((e1 (stress-check arr1 5000 (* round 7)))
            (e2 (stress-check arr2 5000 (* round 13)))
            (e3 (stress-check arr3 1000 (+ (* round 29) 1))))
        (incf errors (+ e1 e2 e3))
        (stress-bar 130 108 130 12 3 3 28)
        (stress-bar 130 126 130 12 3 3 28)
        (stress-bar 130 144 130 12 3 3 28))
      (audio-note 0 (+ 48 (mod round 36)) 200)
      (stress-bar 130 192 130 12 1 2 195)
      (let ((gx (+ 280 (mod (* round 17) 222)))
            (gy (+ 54 (mod (* round 23) 180)))
            (gr (+ 3 (mod round 15)))
            (gc (mod (* round 37) 256)))
        (fill-circle gx gy gr gc))
      (stress-bar 130 216 130 12 (mod round 20) 20 3)
      (let ((e1 (stress-check arr1 5000 (* round 7)))
            (e2 (stress-check arr2 5000 (* round 13))))
        (let ((late-errs (+ e1 e2)))
          (incf errors late-errs)
          (when (> late-errs 0)
            (stress-log (format nil "!!! ~a errors in round ~a" late-errs round) 192))))
      (fill-rect 80 85 150 8 0)
      (stress-text 80 85
        (format nil "~as" (truncate (- (millis) start-time) 1000)) 223)
      (fill-rect 80 55 150 8 0)
      (stress-text 80 55
        (if (= errors 0) "0 - CLEAN" (format nil "~a - FAILURES" errors))
        (if (= errors 0) 28 192))
      (let ((k (keyboard)))
        (when (and k (= (key-code k) 27))
          (mouse-hide)
          (audio-stop-all)
          (text-mode)
          (format t "~%Stress test complete: ~a rounds, ~a errors, ~as~%"
            round errors (truncate (- (millis) start-time) 1000))
          (return errors)))
      (when (and (> max-rounds 0) (>= round max-rounds))
        (mouse-hide)
        (audio-stop-all)
        (text-mode)
        (format t "~%Stress test complete: ~a rounds, ~a errors, ~as~%"
          round errors (truncate (- (millis) start-time) 1000))
        (return errors))
      (delay 10))))
